<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Code and Iron Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Germania One font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Germania+One&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #000;
      --card: #121212;
      --card-inner: #1a1a1a;
      --text-main: #fff;
      --text-muted: #bbbbbb;
      --accent: #0a84ff;
      --accent-soft: #005fd1;
      --danger: #d93030;
      --danger-soft: #a52424;
      --border-soft: #2a2a2a;
      --radius-card: 24px;
      --radius-pill: 999px;
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.7);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Germania One", -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
    }

    .app-wrapper {
      min-height: 100vh;
      padding: 12px 12px 32px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 8px 4px 16px;
    }

    .app-header h1 {
      font-size: 32px;
      font-weight: 800;
      margin: 0;
      letter-spacing: 0.5px;
    }

    .menu-button {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid #333;
      background-color: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .menu-button:active {
      background-color: #222;
    }

    .menu-icon {
      width: 18px;
      height: 18px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .menu-icon span {
      display: block;
      height: 3px;
      border-radius: 999px;
      background-color: #fff;
    }

    .menu-dropdown {
      position: absolute;
      right: 16px;
      top: 64px;
      background-color: #111;
      border-radius: 16px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-8px);
      transition: opacity 0.18s ease, transform 0.18s ease;
      min-width: 220px;
      z-index: 20;
    }

    .menu-dropdown.open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .menu-item {
      padding: 14px 18px;
      font-size: 16px;
      border-bottom: 1px solid #222;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item:active {
      background-color: #1f1f1f;
    }

    main.screen {
      display: none;
      flex: 1;
    }

    main.screen.active {
      display: block;
    }

    .card {
      max-width: 480px;
      margin: 0 auto;
      background-color: var(--card);
      border-radius: var(--radius-card);
      padding: 18px 16px 24px;
      box-shadow: var(--shadow-soft);
    }

    .card-title {
      font-size: 22px;
      font-weight: 700;
      margin: 4px 4px 8px;
    }

    .card-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0 4px 16px;
      line-height: 1.4;
    }

    .input-label {
      display: block;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .text-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid #333;
      background-color: #000;
      color: var(--text-main);
      font-size: 16px;
    }

    .text-input::placeholder {
      color: #666;
    }

    .workouts-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
      margin-bottom: 12px;
    }

    .workout-card {
      background-color: var(--card-inner);
      border-radius: 20px;
      padding: 14px 12px 16px;
      border: 1px solid var(--border-soft);
    }

    .workout-name {
      margin-bottom: 0;
    }

    .workout-header {
  display: flex;
  align-items: stretch;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 10px;
}


.workout-header .workout-name {
  flex: 1;   
  height: 44px;
  padding: 0 12px;
}


.workout-header-actions {
  display: flex;
  gap: 8px;
}

    
    .danger-btn,
    .primary-btn {
      width: 100%;
      border-radius: var(--radius-pill);
      padding: 11px 16px;
      font-size: 17px;
      font-weight: 600;
      border: none;
      color: #fff;
    }

    .danger-btn {
      background-color: var(--danger);
      margin: 4px 0 10px;
    }

    .danger-btn:active {
      background-color: var(--danger-soft);
    }

    .primary-btn {
  width: 100%;
  border-radius: 12px;  /* keep your pill shape */
  padding: 11px 16px;
  font-size: 17px;
  font-weight: 600;
  border: 1px solid #333;
  color: #fff;
  margin-top: 8px;

  background-color: #000;             /* match +/- buttons */
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);

  -webkit-tap-highlight-color: transparent;
  -webkit-appearance: none;
  appearance: none;
}

.primary-btn:active {
  transform: translateY(1px);
  opacity: 0.9;
  background-color: #111 !important;  /* correct syntax */
  border-color: #333 !important;
}



    .footer-btn {
      margin-top: 10px;
    }

    .set-box {
      background-color: #151515;
      border-radius: 16px;
      padding: 10px 10px 12px;
      border: 1px solid #262626;
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .set-header {
      font-size: 15px;
      font-weight: 700;
      color: #ffb74d;
      margin-bottom: 6px;
    }

/* Progress screen letter group headers */
.progress-letter-header {
  margin-top: 10px;
  margin-bottom: 4px;
  font-size: 13px;
  font-weight: 700;
  color: #888;
  text-transform: uppercase;
}

/* Rows inside the progress detail panel */
.progress-detail-row {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  margin-bottom: 4px;
}

.progress-detail-row span:first-child {
  color: #bbbbbb;
}

.progress-detail-row span:last-child {
  color: #ffffff;
  font-weight: 600;
}


.set-row {
  display: flex;
  align-items: center;      
  gap: 10px;
  margin-bottom: 6px;
}

.set-fields {
  flex: 1;
  display: flex;
  gap: 8px;
  align-items: center;
}

.set-input {
  width: 100%;
  padding: 0 10px;
  height: 44px;             
  border-radius: 12px;
  background-color: #000;
  border: 1px solid #333;
  color: #fff;
  font-size: 15px;
  text-align: center;
}

.set-input::placeholder {
  color: #666;
}

.set-actions {
  display: flex;
  gap: 8px;
}


.round-btn {
  -webkit-appearance: none;
  appearance: none;
  background-color: #000;        
  border: 1px solid #333;        
  color: #fff;
  height: 44px;                 
  min-width: 56px;              
  border-radius: 12px;          
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 700;
  padding: 0 10px;              
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
}

.round-btn:active {
  transform: translateY(1px);
  opacity: 0.9;
  background-color: #111;
}

    .set-col {
      flex: 1;
    }

    .set-col label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }



    .remove-set-btn {
      width: 100%;
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background-color: #802121;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
    }

    .remove-set-btn:active {
      background-color: #5c1818;
    }

    .saved-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .saved-wrapper {
      margin-top: 4px;
    }

    .saved-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 14px;
      background-color: #151515;
      border: 1px solid #262626;
      font-size: 15px;
    }

    .saved-name {
      flex: 1;
      margin-right: 10px;
    }

    .saved-buttons {
      display: flex;
      gap: 6px;
    }

.small-btn {
  -webkit-appearance: none;
  appearance: none;
  -webkit-tap-highlight-color: transparent;

  border-radius: 12px;             /* match other buttons */
  border: 1px solid #333;
  padding: 6px 12px;               /* keep size similar */
  font-size: 13px;
  font-weight: 600;
  color: #fff;

  background-color: #000;          /* dark theme like other buttons */
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
}

.small-btn:active {
  transform: translateY(1px);
  opacity: 0.9;
  background-color: #111;
}


    .open-panel {
      margin-top: 8px;
      padding: 10px 10px 14px;
      border-radius: 18px;
      background-color: #101010;
      border: 1px solid #262626;
      display: none;
    }

    .open-panel.open {
      display: block;
    }

    .link-back {
      margin-top: 18px;
      font-size: 15px;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .link-back span {
      font-size: 18px;
      line-height: 1;
    }

    .link-back:active {
      color: #ffffff;
    }

    .input-group {
      margin: 6px 0 10px;
    }

    @media (min-width: 500px) {
      .app-wrapper {
        align-items: center;
      }
      .card {
        width: 430px;
      }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <header class="app-header">
      <h1>Code and Iron Test</h1>
      <button class="menu-button" id="menuButton" aria-label="Open menu">
        <div class="menu-icon">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>
    </header>

    <!-- Menu -->
    <div class="menu-dropdown" id="menuDropdown">
  <div class="menu-item" data-nav="workouts">Routines</div>
  <div class="menu-item" data-nav="progress">Progress</div>
</div>

    <!-- HOME / LOGGER SCREEN -->
    <main id="homeScreen" class="screen active">
  <section class="card">
    <div id="workoutsContainer" class="workouts-container"></div>
    <button id="saveProgressBtn" class="primary-btn footer-btn">
      Save progress
    </button>
  </section>
</main>

    <!-- ROUTINES SCREEN -->
<!-- ROUTINES SCREEN -->
<main id="workoutsScreen" class="screen">
  <section class="card">
    <h2 class="card-title">Workouts</h2>
    <p class="card-subtitle">
      Create and save exercise routines you can load later on the main page.
    </p>

    <div class="input-group">
      <label class="input-label" for="templateNameInput">New routine name</label>
      <input
        id="templateNameInput"
        class="text-input"
        placeholder="e.g. Chest, Legs, Shoulders, Back"
      />
    </div>

    <button id="saveTemplateBtn" class="primary-btn">
      Create
    </button>

    <h3 class="card-subtitle" style="margin-top:18px;margin-bottom:4px;">
      Saved workouts
    </h3>
    <div id="savedTemplatesList" class="saved-list"></div>

    <div class="link-back" id="backToLogger">
      <span>←</span> Back to workout logger
    </div>
  </section>
</main>

<!-- PROGRESS SCREEN (now a separate screen) -->
  <main id="progressScreen" class="screen">
  <section class="card">
    <h2 class="card-title">Progress</h2>
    <p class="card-subtitle">
      Your best sets for each exercise based on saved workouts.
    </p>

    <div id="progressList" class="saved-list"></div>

    <!-- Detail panel for a single exercise -->
    <div id="progressDetail" class="open-panel"></div>

    <div class="link-back" id="backToLoggerFromProgress">
      <span>←</span> Back to workout logger
    </div>
  </section>
</main>
  </div>

  <script>
    // ---------- Helpers: exercise card + sets ----------

  function createSetBox(card, setData, indexOverride) {
  const existing = card.querySelectorAll(".set-box").length;
  const setNumber = indexOverride || existing + 1;

  const box = document.createElement("div");
  box.className = "set-box";

  // "Set 1"
  const header = document.createElement("div");
  header.className = "set-header";
  header.textContent = "Set " + setNumber;
  box.appendChild(header);

  // Row that holds fields + +/- buttons
  const row = document.createElement("div");
  row.className = "set-row";

  // Left side: fields
  const fields = document.createElement("div");
  fields.className = "set-fields";

  

  const colWeight = document.createElement("div");
  colWeight.className = "set-col";

  const weightInput = document.createElement("input");
  weightInput.className = "set-input";
  weightInput.type = "text";
  weightInput.placeholder = "Weight";   // NEW
  if (setData && setData.weight != null) {
    weightInput.value = setData.weight;
  }
  colWeight.appendChild(weightInput);

  const colReps = document.createElement("div");
  colReps.className = "set-col";

  const repsInput = document.createElement("input");
  repsInput.className = "set-input";
  repsInput.type = "number";
  repsInput.min = "0";
  repsInput.placeholder = "Reps";       // NEW
  if (setData && setData.reps != null) {
    repsInput.value = setData.reps;
  }
  colReps.appendChild(repsInput);

  fields.appendChild(colWeight);
  fields.appendChild(colReps);

  // Right side: round +/- buttons
  const actions = document.createElement("div");
  actions.className = "set-actions";

  const minusBtn = document.createElement("button");
  minusBtn.className = "round-btn minus";
  minusBtn.textContent = "–";
  minusBtn.addEventListener("click", () => {
    const allSets = card.querySelectorAll(".set-box");
    if (allSets.length > 1) {
      box.remove();
      // renumber remaining sets
      card.querySelectorAll(".set-box").forEach((b, i) => {
        const h = b.querySelector(".set-header");
        if (h) h.textContent = "Set " + (i + 1);
      });
    }
  });

  const plusBtn = document.createElement("button");
  plusBtn.className = "round-btn plus";
  plusBtn.textContent = "+";
  plusBtn.addEventListener("click", () => {
    const newBox = createSetBox(card);
    const wrapper =
      card.querySelector(".sets-wrapper") || card;
    wrapper.appendChild(newBox);
  });

  actions.appendChild(minusBtn);
  actions.appendChild(plusBtn);

  // put left + right into the row
  row.appendChild(fields);
  row.appendChild(actions);
  box.appendChild(row);

  return box;
}

function createWorkoutCard(parent, workoutData) {
  const card = document.createElement("div");
  card.className = "workout-card";

  // --- Sets wrapper (we'll need this in the header + button) ---
  const setsWrapper = document.createElement("div");
  setsWrapper.className = "sets-wrapper";

  // --- HEADER ROW: exercise name + big +/- ---
  const header = document.createElement("div");
  header.className = "workout-header";

  // Exercise name input (now half width via CSS)
  const nameInput = document.createElement("input");
  nameInput.className = "text-input workout-name";
  nameInput.placeholder = "Enter exercise name";
  if (workoutData && workoutData.name) {
    nameInput.value = workoutData.name;
  }

  // Right side of header: round - and + buttons
  const headerActions = document.createElement("div");
  headerActions.className = "workout-header-actions";

  // Header "-" = remove this exercise card,
// but if it's the only one, just reset it instead of removing
const removeWorkoutBtn = document.createElement("button");
removeWorkoutBtn.className = "round-btn minus";
removeWorkoutBtn.textContent = "–";
removeWorkoutBtn.addEventListener("click", () => {
  const allCards = parent.querySelectorAll(".workout-card");

  if (allCards.length <= 1) {
    // Reset this card instead of removing it
    // Clear exercise name
    nameInput.value = "";

    // Reset sets to a single empty Set 1
    const setsWrapper = card.querySelector(".sets-wrapper");
    if (setsWrapper) {
      setsWrapper.innerHTML = "";
      const setBox = createSetBox(card, { weight: "", reps: "" }, 1);
      setsWrapper.appendChild(setBox);
    }
  } else {
    // More than one exercise – safe to remove this card
    card.remove();
  }
});

  // Header "+" = add a new set to this exercise
    // Header "+" = add a NEW EXERCISE card below
  const addExerciseBtn = document.createElement("button");
  addExerciseBtn.className = "round-btn plus";
  addExerciseBtn.textContent = "+";
  addExerciseBtn.addEventListener("click", () => {
    createWorkoutCard(parent);
  });

  headerActions.appendChild(removeWorkoutBtn);
  headerActions.appendChild(addExerciseBtn);

  header.appendChild(nameInput);
  header.appendChild(headerActions);

  // Put header and sets wrapper into the card
  card.appendChild(header);
  card.appendChild(setsWrapper);

  // --- Initial sets ---
  const setsFromData =
    workoutData && Array.isArray(workoutData.sets)
      ? workoutData.sets
      : [{ weight: "", reps: "" }];

  setsFromData.forEach((set, idx) => {
    const setBox = createSetBox(card, set, idx + 1);
    setsWrapper.appendChild(setBox);
  });

  parent.appendChild(card);
  return card;
}

    // ---------- Screens & navigation ----------

    const menuButton = document.getElementById("menuButton");
    const menuDropdown = document.getElementById("menuDropdown");
    const homeScreen = document.getElementById("homeScreen");
    const workoutsScreen = document.getElementById("workoutsScreen");
    const progressScreen = document.getElementById("progressScreen");
    const progressDetail = document.getElementById("progressDetail");
    
    function renderProgressList() {
  const list = document.getElementById("progressList");
  list.innerHTML = "";

  const entries = Object.values(progressData);
  if (!entries.length) {
    const empty = document.createElement("div");
    empty.className = "card-subtitle";
    empty.textContent =
      "No progress saved yet. Log a workout on the home screen and tap 'Save progress'.";
    list.appendChild(empty);
    // also hide detail panel if open
    if (progressDetail) {
      progressDetail.classList.remove("open");
      progressDetail.innerHTML = "";
    }
    return;
  }

  const today = new Date().toISOString().split("T")[0];

  // Sort alphabetically by exercise name
  entries.sort((a, b) => a.name.localeCompare(b.name));

  let currentLetter = null;

  entries.forEach((ex) => {
    if (!ex.name) return;

    const firstLetter = ex.name.charAt(0).toUpperCase();

    // NEW: letter group header
    if (firstLetter !== currentLetter) {
      currentLetter = firstLetter;
      const letterHeader = document.createElement("div");
      letterHeader.className = "progress-letter-header";
      letterHeader.textContent = currentLetter;
      list.appendChild(letterHeader);
    }

    const row = document.createElement("div");
    row.className = "saved-item";

    const nameDiv = document.createElement("div");
    nameDiv.className = "saved-name";
    nameDiv.textContent = ex.name;
    row.appendChild(nameDiv);

    const detail = document.createElement("div");
    detail.style.fontSize = "13px";
    detail.style.color = "#bbbbbb";

    let prText = "";

    if (ex.bestRepsDate && ex.bestRepsDate.startsWith(today)) {
      prText += " (NEW REP PR!)";
    }

    if (ex.bestWeightDate && ex.bestWeightDate.startsWith(today)) {
      prText += " (NEW WEIGHT PR!)";
    }

    if (ex.bestWeight !== null) {
      detail.textContent = `Best: ${ex.bestWeight} x ${ex.bestWeightReps} • Max reps: ${ex.bestReps}${prText}`;
    } else {
      detail.textContent = `Best: ${ex.bestReps} reps${prText}`;
    }

    row.appendChild(detail);

    // NEW: tap row to open detail panel
    row.addEventListener("click", () => {
      openProgressDetail(ex);
    });

    list.appendChild(row);
  });
}
    
    function closeMenu() {
      menuDropdown.classList.remove("open");
    }

    menuButton.addEventListener("click", () => {
      menuDropdown.classList.toggle("open");
    });

    document.addEventListener("click", (e) => {
      if (!menuButton.contains(e.target) && !menuDropdown.contains(e.target)) {
        closeMenu();
      }
    });

document.querySelectorAll(".menu-item").forEach((item) => {
  item.addEventListener("click", () => {
    const nav = item.dataset.nav;
    if (nav === "workouts" || nav === "progress") {
      showScreen(nav);
      if (nav === "progress") {
        renderProgressList(); // refresh whenever you open Progress
      }
    }
    closeMenu();
  });
});

// Back link on Progress screen
const backToLoggerFromProgress = document.getElementById("backToLoggerFromProgress");
if (backToLoggerFromProgress) {
  backToLoggerFromProgress.addEventListener("click", () => {
    showScreen("home");
  });
}

    function showScreen(which) {
  if (which === "home") {
    homeScreen.classList.add("active");
    workoutsScreen.classList.remove("active");
    progressScreen.classList.remove("active");
  } else if (which === "workouts") {
    homeScreen.classList.remove("active");
    workoutsScreen.classList.add("active");
    progressScreen.classList.remove("active");
  } else if (which === "progress") {
    homeScreen.classList.remove("active");
    workoutsScreen.classList.remove("active");
    progressScreen.classList.add("active");
  }

  // clear detail panel when not on progress
  if (which !== "progress" && progressDetail) {
    progressDetail.classList.remove("open");
    progressDetail.innerHTML = "";
  }
}
    // ---------- Logger (home) ----------

    const workoutsContainer = document.getElementById("workoutsContainer");
    const saveProgressBtn = document.getElementById("saveProgressBtn");
    
    saveProgressBtn.addEventListener("click", () => {
  saveCurrentProgress();
  alert("Progress saved!");
});
    
    // ---------- Progress detail panel (last 5 logs) ----------

function formatDateLabel(isoDate) {
  // isoDate will be 'YYYY-MM-DD'
  if (!isoDate) return "";
  const d = new Date(isoDate);
  return d.toLocaleDateString(undefined, {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}

function openProgressDetail(ex) {
  if (!progressDetail) return;

  progressDetail.classList.add("open");
  progressDetail.innerHTML = "";

  // Title
  const title = document.createElement("div");
  title.className = "card-subtitle";
  title.style.marginBottom = "8px";
  title.textContent = ex.name + " — last sessions";
  progressDetail.appendChild(title);

  // PR info (if available)
  if (ex.bestRepsDate || ex.bestWeightDate) {
    const prInfo = document.createElement("div");
    prInfo.style.fontSize = "13px";
    prInfo.style.color = "#bbbbbb";
    prInfo.style.marginBottom = "8px";

    const parts = [];
    if (ex.bestRepsDate) {
      parts.push(
        `Rep PR: ${ex.bestReps} reps on ${formatDateLabel(
          ex.bestRepsDate.split("T")[0]
        )}`
      );
    }
    if (ex.bestWeightDate && ex.bestWeight !== null) {
      parts.push(
        `Weight PR: ${ex.bestWeight} x ${ex.bestWeightReps} on ${formatDateLabel(
          ex.bestWeightDate.split("T")[0]
        )}`
      );
    }

    prInfo.textContent = parts.join(" • ");
    progressDetail.appendChild(prInfo);
  }

  // History list
  const history = (ex.history || []).slice(0, 5); // last 5 logs
  if (!history.length) {
    const empty = document.createElement("div");
    empty.style.fontSize = "13px";
    empty.style.color = "#bbbbbb";
    empty.textContent =
      "No detailed history yet. Save progress a few times for this exercise.";
    progressDetail.appendChild(empty);
    return;
  }

  history.forEach((entry) => {
    const row = document.createElement("div");
    row.className = "progress-detail-row";

    const left = document.createElement("span");
    left.textContent = formatDateLabel(entry.date);

    const right = document.createElement("span");
    if (entry.bestWeight !== null) {
      right.textContent = `${entry.bestWeight} x ${entry.bestWeightReps} • Max reps: ${entry.bestReps}`;
    } else {
      right.textContent = `Best: ${entry.bestReps} reps`;
    }

    row.appendChild(left);
    row.appendChild(right);
    progressDetail.appendChild(row);
  });
}
    
    
    function saveCurrentProgress() {
  const workouts = getCurrentWorkoutLayout();
  if (!workouts || !workouts.length) return;

  const now = new Date().toISOString();
  const today = now.split("T")[0]; // YYYY-MM-DD
  const updated = { ...progressData };

  workouts.forEach((w) => {
    const rawName = (w.name || "").trim();
    if (!rawName) return;

    const key = rawName.toLowerCase();
    let maxReps = 0;
    let bestWeight = null;
    let bestWeightReps = 0;

    (w.sets || []).forEach((set) => {
      const repsNum = parseInt(set.reps, 10);
      if (!repsNum || isNaN(repsNum)) return;

      const weightStr = (set.weight || "").trim();
      const weightNum = parseFloat(weightStr);

      // Track max reps (for bodyweight or any type)
      if (repsNum > maxReps) maxReps = repsNum;

      // If weight is numeric, track best weight x reps
      if (!isNaN(weightNum)) {
        if (
          bestWeight === null ||
          weightNum > bestWeight ||
          (weightNum === bestWeight && repsNum > bestWeightReps)
        ) {
          bestWeight = weightNum;
          bestWeightReps = repsNum;
        }
      }
    });

    if (maxReps === 0 && bestWeight === null) return;

    const existing = updated[key] || {
      name: rawName,
      bestReps: 0,
      bestRepsDate: null,
      bestWeight: null,
      bestWeightReps: 0,
      bestWeightDate: null,
      lastUpdated: null,
      history: []   // NEW: keep per-day snapshots
    };

    // Update overall best reps
    if (maxReps > existing.bestReps) {
      existing.bestReps = maxReps;
      existing.bestRepsDate = now;
    }

    // Update overall best weight x reps
    if (bestWeight !== null) {
      if (
        existing.bestWeight === null ||
        bestWeight > existing.bestWeight ||
        (bestWeight === existing.bestWeight &&
          bestWeightReps > existing.bestWeightReps)
      ) {
        existing.bestWeight = bestWeight;
        existing.bestWeightReps = bestWeightReps;
        existing.bestWeightDate = now;
      }
    }

    // --- NEW: store today’s snapshot in history ---
    const snapshot = {
      date: today,               // YYYY-MM-DD
      bestReps: maxReps,
      bestWeight: bestWeight,
      bestWeightReps: bestWeightReps
    };

    existing.history = existing.history || [];
    // replace entry for this same date if it exists
    existing.history = existing.history.filter((h) => h.date !== today);
    existing.history.push(snapshot);

    // keep most recent first
    existing.history.sort((a, b) => b.date.localeCompare(a.date));

    // (optional) cap history length (e.g. last 30 logs)
    if (existing.history.length > 30) {
      existing.history = existing.history.slice(0, 30);
    }

    existing.lastUpdated = now;
    existing.name = rawName; // keep latest capitalization
    updated[key] = existing;
  });

  progressData = updated;
  saveProgress(progressData);
}
    
    function getCurrentWorkoutLayout() {
      return getWorkoutLayoutFrom(workoutsContainer);
    }

    function applyTemplateToHome(workoutDataArray) {
      workoutsContainer.innerHTML = "";
      if (!workoutDataArray || workoutDataArray.length === 0) {
        createWorkoutCard(workoutsContainer);
        return;
      }
      workoutDataArray.forEach((w) => {
        createWorkoutCard(workoutsContainer, w);
      });
    }

    // ---------- Templates (routines screen) ----------
    // ---------- Templates (routines screen) ----------

    const templateNameInput = document.getElementById("templateNameInput");
    const saveTemplateBtn = document.getElementById("saveTemplateBtn");
    const savedTemplatesList = document.getElementById("savedTemplatesList");
    const backToLogger = document.getElementById("backToLogger");

    const STORAGE_KEY = "codeAndIronTemplates_v2";
    
    const PROGRESS_KEY = "codeAndIronProgress_v1";

function loadProgress() {
  try {
    const raw = localStorage.getItem(PROGRESS_KEY);
    if (!raw) return {};
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === "object" ? parsed : {};
  } catch (e) {
    console.error("Error loading progress", e);
    return {};
  }
}

function saveProgress(progress) {
  try {
    localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
  } catch (e) {
    console.error("Error saving progress", e);
  }
}

let progressData = loadProgress();
    
    function loadTemplates() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("Error loading templates", e);
        return [];
      }
    }

    function saveTemplates(templates) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(templates));
      } catch (e) {
        console.error("Error saving templates", e);
      }
    }

    let templates = loadTemplates();

    function getWorkoutLayoutFrom(container) {
      const cards = container.querySelectorAll(".workout-card");
      const workouts = [];

      cards.forEach((card) => {
        const nameInput = card.querySelector(".workout-name");
        const sets = [];
        card.querySelectorAll(".set-box").forEach((box) => {
          const inputs = box.querySelectorAll(".set-input");
          sets.push({
            weight: inputs[0] ? inputs[0].value : "",
            reps: inputs[1] ? inputs[1].value : "",
          });
        });
        workouts.push({
          name: nameInput ? nameInput.value : "",
          sets,
        });
      });

      return workouts;
    }

function buildEditorPanel(panel, tpl) {
  panel.innerHTML = "";
  panel.classList.add("open");

  const innerContainer = document.createElement("div");
  innerContainer.className = "workouts-container";
  panel.appendChild(innerContainer);

  const data =
    tpl.workouts && tpl.workouts.length
      ? tpl.workouts
      : [{ name: "", sets: [{ weight: "", reps: "" }] }];

  data.forEach((w) => createWorkoutCard(innerContainer, w));
}


    function closePanelAndSave(panel) {
      const index = parseInt(panel.dataset.index, 10);
      if (!isNaN(index) && templates[index]) {
        const container = panel.querySelector(".workouts-container");
        if (container) {
          templates[index].workouts = getWorkoutLayoutFrom(container);
          saveTemplates(templates);
        }
      }
      panel.classList.remove("open");
      panel.innerHTML = "";
    }

    function renderTemplatesList() {
      savedTemplatesList.innerHTML = "";
      if (!templates.length) return;

      templates.forEach((tpl, index) => {
        const wrapper = document.createElement("div");
        wrapper.className = "saved-wrapper";

        const row = document.createElement("div");
        row.className = "saved-item";

        const name = document.createElement("div");
        name.className = "saved-name";
        name.textContent = tpl.name || "Untitled routine";
        row.appendChild(name);

        const btnWrap = document.createElement("div");
        btnWrap.className = "saved-buttons";

        // LOAD – green
        const loadBtn = document.createElement("button");
        loadBtn.className = "small-btn load";
        loadBtn.textContent = "Load";
        loadBtn.addEventListener("click", () => {
          applyTemplateToHome(tpl.workouts || []);
          showScreen("home");
        });
        btnWrap.appendChild(loadBtn);

        // OPEN/CLOSE – blue
        const openBtn = document.createElement("button");
        openBtn.className = "small-btn open";
        openBtn.textContent = "Open";
        btnWrap.appendChild(openBtn);

        // DELETE – red
        const delBtn = document.createElement("button");
        delBtn.className = "small-btn delete";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => {
          const panel = savedTemplatesList.querySelector(
            `.open-panel[data-index="${index}"]`
          );
          if (panel && panel.classList.contains("open")) {
            closePanelAndSave(panel);
          }
          templates.splice(index, 1);
          saveTemplates(templates);
          renderTemplatesList();
          renderProgressList();
        });
        btnWrap.appendChild(delBtn);

        row.appendChild(btnWrap);
        wrapper.appendChild(row);

        // dropdown panel for "Open"
        const panel = document.createElement("div");
        panel.className = "open-panel";
        panel.dataset.index = index.toString();
        wrapper.appendChild(panel);

        openBtn.addEventListener("click", () => {
          if (panel.classList.contains("open")) {
            closePanelAndSave(panel);
            openBtn.textContent = "Open";
            return;
          }

          // close & save any other open panels
          document
            .querySelectorAll(".open-panel.open")
            .forEach((p) => {
              if (p !== panel) {
                const btnIndex = p.dataset.index;
                const otherBtn = savedTemplatesList.querySelector(
                  `.saved-wrapper:nth-child(${parseInt(btnIndex, 10) + 1}) .small-btn.open`
                );
                if (otherBtn) otherBtn.textContent = "Open";
                closePanelAndSave(p);
              }
            });

          buildEditorPanel(panel, tpl);
          openBtn.textContent = "Close";
        });

        savedTemplatesList.appendChild(wrapper);
      });
    }

    // SAVE TEMPLATE button logic
    saveTemplateBtn.addEventListener("click", () => {
      const name = templateNameInput.value.trim();
      if (!name) {
        alert("Give this routine a name first.");
        return;
      }

      // Read current layout from home screen
      const workoutsData = getCurrentWorkoutLayout();

      // If nothing on screen, still create an empty routine structure
      const safeWorkouts =
        workoutsData && workoutsData.length
          ? workoutsData
          : [{ name: "", sets: [{ weight: "", reps: "" }] }];

      templates.push({
        id: Date.now(),
        name,
        workouts: JSON.parse(JSON.stringify(safeWorkouts)),
      });

      saveTemplates(templates);
      renderTemplatesList();
      templateNameInput.value = "";
    });

    backToLogger.addEventListener("click", () => {
      showScreen("home");
    });

    // ---------- Init ----------

    function init() {
      createWorkoutCard(workoutsContainer); // one empty exercise by default
      renderTemplatesList();
    }

    init();
  </script>
</body>
</html>
